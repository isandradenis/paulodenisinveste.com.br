<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora do Primeiro Milh√£o</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0c0f;
    --surface: #111318;
    --surface2: #181c23;
    --border: #1e2330;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --green: #22c55e;
    --text: #e8eaf0;
    --muted: #6b7280;
    --accent: #3b82f6;
    --red: #f87171;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 70% 40% at 10% 0%, rgba(201,168,76,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 50% 40% at 90% 100%, rgba(34,197,94,0.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 1160px;
    margin: 0 auto;
    padding: 48px 24px 80px;
    position: relative;
    z-index: 1;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    text-align: center;
    margin-bottom: 48px;
    animation: fadeDown 0.7s ease both;
  }

  .eyebrow {
    font-size: 11px;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 14px;
    font-weight: 500;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.2rem, 5.5vw, 3.6rem);
    font-weight: 900;
    line-height: 1.1;
    color: var(--text);
    margin-bottom: 14px;
  }

  h1 .million {
    color: var(--gold);
    position: relative;
    display: inline-block;
  }

  .subtitle {
    color: var(--muted);
    font-size: 15px;
    font-weight: 300;
    max-width: 480px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
  .main-grid {
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 820px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    animation: fadeUp 0.6s ease both;
  }

  .section-label {
    font-size: 11px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--gold);
    font-weight: 500;
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ Form fields ‚îÄ‚îÄ */
  .field { margin-bottom: 20px; }

  label {
    display: block;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .input-wrap { position: relative; }

  .prefix {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    pointer-events: none;
  }

  .percent-suffix {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    pointer-events: none;
  }

  input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 15px;
    padding: 12px 14px 12px 36px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -moz-appearance: textfield;
  }

  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

  input[type="number"]:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(201,168,76,0.12);
  }

  input[type="number"].with-suffix { padding-right: 36px; padding-left: 14px; }

  .toggle-group {
    display: flex;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  .toggle-group label {
    flex: 1;
    text-align: center;
    cursor: pointer;
    padding: 11px 8px;
    font-size: 13px;
    color: var(--muted);
    margin: 0;
    transition: all 0.2s;
    letter-spacing: 0;
  }

  .toggle-group input[type="radio"] { display: none; }

  .toggle-group input[type="radio"]:checked + label {
    background: var(--gold);
    color: #0a0c0f;
    font-weight: 600;
  }

  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 22px 0;
  }

  .btn-calc {
    width: 100%;
    background: var(--gold);
    color: #0a0c0f;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border: none;
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 4px 24px rgba(201,168,76,0.2);
  }

  .btn-calc:hover {
    background: var(--gold-light);
    transform: translateY(-1px);
    box-shadow: 0 8px 32px rgba(201,168,76,0.3);
  }

  .btn-calc:active { transform: translateY(0); }

  /* Summary under button */
  .summary-below {
    margin-top: 20px;
    display: none;
    flex-direction: column;
    gap: 10px;
  }

  .stat-inline {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 13px 16px;
  }

  .stat-inline.highlight { border-color: rgba(201,168,76,0.4); }
  .stat-inline.green-row { border-color: rgba(34,197,94,0.2); }

  .stat-inline-label { font-size: 12px; color: var(--muted); font-weight: 500; }

  .stat-inline-value {
    font-family: 'DM Mono', monospace;
    font-size: 13.5px;
    font-weight: 600;
    color: var(--text);
  }

  .stat-inline.highlight .stat-inline-value { color: var(--gold); }
  .stat-inline.green-row .stat-inline-value  { color: var(--green); }

  /* ‚îÄ‚îÄ Results panel ‚îÄ‚îÄ */
  .results-panel {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 56px 20px;
    color: var(--muted);
    text-align: center;
    gap: 12px;
  }

  .empty-icon { font-size: 48px; opacity: 0.25; }
  .empty-state p { font-size: 14px; max-width: 280px; line-height: 1.7; }

  .hidden { display: none !important; }

  /* ‚îÄ‚îÄ Section cards ‚îÄ‚îÄ */
  .section-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    animation: fadeUp 0.6s ease both;
  }

  .section-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 6px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .section-card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
  }

  .badge {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .badge-gold  { background: rgba(201,168,76,0.15); color: var(--gold);   border: 1px solid rgba(201,168,76,0.3); }
  .badge-green { background: rgba(34,197,94,0.12);  color: var(--green);  border: 1px solid rgba(34,197,94,0.25); }
  .badge-accent{ background: rgba(139,92,246,0.15); color: #a78bfa;       border: 1px solid rgba(139,92,246,0.3); }

  .section-desc {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Milestone list ‚îÄ‚îÄ */
  .milestones {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 28px;
  }

  .milestone-row {
    display: grid;
    align-items: center;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 16px;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    overflow: hidden;
  }

  .milestone-row.g10k  { grid-template-columns: 1fr auto; }
  .milestone-row.g100k { grid-template-columns: 1fr auto; }

  .milestone-row::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
  }

  .milestone-row.g10k::before  { background: var(--gold); }
  .milestone-row.g100k::before { background: var(--green); }

  .milestone-row:hover {
    background: #1c212c;
    border-color: #2a3040;
  }

  .milestone-range {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--text);
  }

  .milestone-time {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .milestone-time .months-val {
    font-size: 16px;
    font-weight: 700;
  }

  .g10k  .milestone-time .months-val { color: var(--gold); }
  .g100k .milestone-time .months-val { color: var(--green); }

  .faster-badge {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.05em;
    background: rgba(34,197,94,0.15);
    color: var(--green);
    border-radius: 4px;
    padding: 2px 6px;
    margin-left: 6px;
  }

  /* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
  .chart-wrap {
    position: relative;
    background: var(--surface2);
    border-radius: 12px;
    padding: 6px 6px 2px;
    border: 1px solid var(--border);
    margin-top: 4px;
  }

  .chart-title-text {
    text-align: center;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    padding: 10px 0 2px;
    letter-spacing: 0.01em;
  }

  canvas { border-radius: 4px; }

  /* ‚îÄ‚îÄ Insight box ‚îÄ‚îÄ */
  .insight-box {
    margin-top: 20px;
    background: linear-gradient(135deg, rgba(201,168,76,0.08), rgba(34,197,94,0.05));
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 12px;
    padding: 16px 20px;
    font-size: 13.5px;
    color: var(--text);
    line-height: 1.7;
  }

  .insight-box strong { color: var(--gold); }
  .insight-box.green-insight {
    background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(59,130,246,0.04));
    border-color: rgba(34,197,94,0.2);
  }
  .insight-box.green-insight strong { color: var(--green); }

  .insight-box.accent-insight {
    background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(59,130,246,0.04));
    border-color: rgba(139,92,246,0.2);
  }
  .insight-box.accent-insight strong { color: #a78bfa; }

  /* Scrollable milestones on mobile */
  .milestones-scroll {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 4px;
  }

  .milestones-scroll::-webkit-scrollbar { width: 4px; }
  .milestones-scroll::-webkit-scrollbar-track { background: var(--surface2); }
  .milestones-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(24px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes rowIn {
    from { opacity: 0; transform: translateX(-10px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  .milestone-row { animation: rowIn 0.3s ease both; }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="eyebrow">Educa√ß√£o Financeira</div>
    <h1>A Jornada ao<br><span class="million">Primeiro Milh√£o</span></h1>
    <p class="subtitle">Veja como os juros compostos aceleram cada etapa do seu caminho ‚Äî e por que o tempo √© o seu maior aliado.</p>
  </header>

  <div class="main-grid">

    <!-- Input Panel -->
    <div class="card" style="animation-delay:0s">
      <div class="section-label">Seus Par√¢metros</div>

      <div class="field">
        <label>Valor Inicial</label>
        <div class="input-wrap">
          <span class="prefix">R$</span>
          <input type="number" id="principal" min="0" step="100" value="5000" placeholder="0">
        </div>
      </div>

      <div class="field">
        <label>Aporte Mensal</label>
        <div class="input-wrap">
          <span class="prefix">R$</span>
          <input type="number" id="aporte" min="0" step="50" value="1000" placeholder="0">
        </div>
      </div>

      <hr class="divider">

      <div class="field">
        <label>Taxa de Juros</label>
        <div class="toggle-group" style="margin-bottom:10px">
          <input type="radio" name="freq_taxa" id="taxa_mensal" value="mensal">
          <label for="taxa_mensal">Mensal</label>
          <input type="radio" name="freq_taxa" id="taxa_anual" value="anual" checked>
          <label for="taxa_anual">Anual</label>
        </div>
        <div class="input-wrap">
          <input type="number" id="taxa" min="0.01" step="0.1" value="12" class="with-suffix" placeholder="0">
          <span class="percent-suffix">%</span>
        </div>
      </div>

      <hr class="divider">

      <button class="btn-calc" onclick="calcular()">Calcular Jornada</button>

      <div class="summary-below" id="summary-below">
        <div class="stat-inline highlight">
          <span class="stat-inline-label">Tempo at√© R$ 1.000.000</span>
          <span class="stat-inline-value" id="res-tempo">‚Äî</span>
        </div>
        <div class="stat-inline">
          <span class="stat-inline-label">Total Investido</span>
          <span class="stat-inline-value" id="res-investido">‚Äî</span>
        </div>
        <div class="stat-inline green-row">
          <span class="stat-inline-label">Juros Ganhos</span>
          <span class="stat-inline-value" id="res-juros">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Results Panel -->
    <div class="results-panel">

      <!-- Empty state (before calc) -->
      <div id="empty-results" class="section-card" style="animation-delay:0.1s">
        <div class="empty-state">
          <div class="empty-icon">üèîÔ∏è</div>
          <p>Preencha seus par√¢metros e clique em <strong>Calcular Jornada</strong> para ver cada etapa do caminho ao seu primeiro milh√£o.</p>
        </div>
      </div>

      <!-- Group 1: R$10k milestones -->
      <div id="section-10k" class="section-card hidden" style="animation-delay:0.1s">
        <div class="section-card-header">
          <div class="section-card-title">Grupos de R$ 10.000</div>
          <span class="badge badge-gold">R$ 0 ‚Üí R$ 100.000</span>
        </div>
        <p class="section-desc">Cada linha mostra quantos meses voc√™ leva para acumular os pr√≥ximos R$ 10.000. Perceba como o tempo vai <em>diminuindo</em> conforme o saldo cresce.</p>

        <div class="milestones-scroll">
          <div class="milestones" id="list-10k"></div>
        </div>

        <div class="chart-wrap">
          <div class="chart-title-text">Evolu√ß√£o patrimonial ‚Äî R$ 0 at√© R$ 100.000</div>
          <canvas id="chart10k" height="200"></canvas>
        </div>

        <div class="insight-box" id="insight-10k"></div>
      </div>

      <!-- Group 2: R$100k milestones -->
      <div id="section-100k" class="section-card hidden" style="animation-delay:0.2s">
        <div class="section-card-header">
          <div class="section-card-title">Grupos de R$ 100.000</div>
          <span class="badge badge-green">R$ 0 ‚Üí R$ 1.000.000</span>
        </div>
        <p class="section-desc">Agora veja o mesmo efeito em escala maior ‚Äî quanto tempo cada bloco de R$ 100.000 leva para ser conquistado.</p>

        <div class="milestones-scroll">
          <div class="milestones" id="list-100k"></div>
        </div>

        <div class="chart-wrap">
          <div class="chart-title-text">Evolu√ß√£o patrimonial ‚Äî R$ 0 at√© R$ 1.000.000</div>
          <canvas id="chart100k" height="200"></canvas>
        </div>

        <div class="insight-box green-insight" id="insight-100k"></div>
      </div>

      <!-- Group 3: Metade do tempo -->
      <div id="section-500k" class="section-card hidden" style="animation-delay:0.3s">
        <div class="section-card-header">
          <div class="section-card-title">O Crescimento N√£o √© Linear</div>
          <span class="badge badge-accent">Metade do tempo √ó Metade do valor?</span>
        </div>
        <p class="section-desc" id="desc-500k">Se o investimento levou <strong id="desc-tempo-total">‚Äî</strong> para atingir R$ 1.000.000, quanto voc√™ acumulou na primeira metade desse tempo? A resposta revela o verdadeiro poder exponencial dos juros compostos.</p>

        <div class="milestones-scroll">
          <div class="milestones" id="list-500k"></div>
        </div>

        <div class="chart-wrap">
          <div class="chart-title-text" id="chart500k-title">Evolu√ß√£o patrimonial ‚Äî divis√£o por tempo</div>
          <canvas id="chart500k" height="220"></canvas>
        </div>

        <div class="insight-box accent-insight" id="insight-500k"></div>
      </div>

    </div>
  </div>
</div>

<script>
  let chart10kInstance  = null;
  let chart100kInstance = null;
  let chart500kInstance = null;

  function fmt(n) {
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
  }
  function fmtFull(n) {
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function fmtAxis(n) {
    if (n >= 1e6) return 'R$' + (n/1e6).toFixed(1).replace('.',',') + 'M';
    if (n >= 1e3) return 'R$' + (n/1e3).toFixed(0) + 'k';
    return 'R$' + n.toFixed(0);
  }
  function mesesParaTexto(m) {
    if (m < 12) return `${m} ${m===1?'m√™s':'meses'}`;
    const anos = Math.floor(m/12), rest = m%12;
    if (rest === 0) return `${anos} ${anos===1?'ano':'anos'}`;
    return `${anos}a ${rest}m`;
  }

  let simData = {};

  function calcular() {
    const principal = parseFloat(document.getElementById('principal').value) || 0;
    const aporte    = parseFloat(document.getElementById('aporte').value)   || 0;
    const taxa      = parseFloat(document.getElementById('taxa').value)     || 0;
    const freqTaxa  = document.querySelector('input[name="freq_taxa"]:checked').value;

    if (taxa <= 0)              { alert('Informe uma taxa de juros v√°lida.'); return; }
    if (principal+aporte <= 0)  { alert('Informe um valor inicial ou aporte mensal.'); return; }

    const taxaMensal = freqTaxa === 'anual'
      ? Math.pow(1 + taxa/100, 1/12) - 1
      : taxa/100;

    const MAX_MESES = 12*200;
    let saldo = principal, mes = 0;

    const th10k  = [0,10000,20000,30000,40000,50000,60000,70000,80000,90000,100000];
    const th100k = [0,100000,200000,300000,400000,500000,600000,700000,800000,900000,1000000];

    const cr10k  = new Array(th10k.length).fill(null);
    const cr100k = new Array(th100k.length).fill(null);
    cr10k[0]=0; cr100k[0]=0;

    const serieA=[{mes:0,valor:principal}]; // up to 100k
    const serieB=[{mes:0,valor:principal}]; // up to 1M
    let reached100k=false, reachedMillion=false, mesDoMilhao=null;

    while (mes < MAX_MESES) {
      saldo = saldo*(1+taxaMensal)+aporte;
      mes++;
      th10k.forEach((t,i)  => { if(cr10k[i]===null  && saldo>=t) cr10k[i]=mes; });
      th100k.forEach((t,i) => { if(cr100k[i]===null && saldo>=t) cr100k[i]=mes; });
      if (!reached100k) { serieA.push({mes,valor:saldo}); if(saldo>=100000) reached100k=true; }
      serieB.push({mes,valor:saldo});
      if (saldo>=1000000 && !reachedMillion) { reachedMillion=true; mesDoMilhao=mes; break; }
    }

    if (!reachedMillion) { alert('Com esses par√¢metros o c√°lculo excede 200 anos.'); return; }

    // ‚îÄ‚îÄ Time-split: find patrimony at exact midpoint in time ‚îÄ‚îÄ
    const mesMeio = Math.round(mesDoMilhao / 2);
    const saldoMeio = serieB.find(p => p.mes === mesMeio)?.valor
                   ?? serieB.reduce((a,b) => Math.abs(b.mes-mesMeio)<Math.abs(a.mes-mesMeio)?b:a).valor;

    const totalInvestido = principal + aporte*mesDoMilhao;
    const juros = saldo - totalInvestido;
    document.getElementById('res-tempo').textContent     = mesesParaTexto(mesDoMilhao);
    document.getElementById('res-investido').textContent = fmtFull(totalInvestido);
    document.getElementById('res-juros').textContent     = fmtFull(juros);
    document.getElementById('summary-below').style.display='flex';

    // Update dynamic text in section 3
    document.getElementById('desc-tempo-total').textContent = mesesParaTexto(mesDoMilhao);
    document.getElementById('chart500k-title').textContent  =
      `Evolu√ß√£o patrimonial ‚Äî ${mesesParaTexto(mesDoMilhao)} at√© R$ 1.000.000`;

    const groups10k = [];
    for (let i=1;i<th10k.length;i++) {
      const end=cr10k[i]; if(end===null) continue;
      groups10k.push({from:th10k[i-1],to:th10k[i],meses:end-(cr10k[i-1]??0),mesCrossed:end});
    }
    const groups100k = [];
    for (let i=1;i<th100k.length;i++) {
      const end=cr100k[i]; if(end===null) continue;
      groups100k.push({from:th100k[i-1],to:th100k[i],meses:end-(cr100k[i-1]??0),mesCrossed:end});
    }

    // Time-split groups: [In√≠cio ‚Üí metade do tempo] and [metade do tempo ‚Üí fim]
    const groupsTempo = [
      { from: 0,          to: saldoMeio, meses: mesMeio,                label: `In√≠cio ‚Üí ${mesesParaTexto(mesMeio)}`,               mesCrossed: mesMeio },
      { from: saldoMeio,  to: 1000000,   meses: mesDoMilhao - mesMeio,  label: `${mesesParaTexto(mesMeio)} ‚Üí ${mesesParaTexto(mesDoMilhao)}`, mesCrossed: mesDoMilhao },
    ];

    simData = {serieA,serieB,groups10k,groups100k,groupsTempo,mesMeio,saldoMeio,mesDoMilhao};

    renderMilestoneList(groups10k,  'list-10k',  'g10k',  '');
    renderMilestoneList(groups100k, 'list-100k', 'g100k', 'background:rgba(34,197,94,0.15);color:var(--green)');
    renderTempoList(groupsTempo, saldoMeio, mesMeio, mesDoMilhao);

    chart10kInstance  = buildChart('chart10k',  serieA, groups10k,  '#c9a84c');
    chart100kInstance = buildChart('chart100k', serieB, groups100k, '#22c55e');
    chart500kInstance = buildChartTempo('chart500k', serieB, mesMeio, saldoMeio, mesDoMilhao);

    const s10=groups10k[0], f10=groups10k[groups10k.length-1];
    document.getElementById('insight-10k').innerHTML =
      `O primeiro bloco de R$ 10.000 levou <strong>${s10.meses} ${s10.meses===1?'m√™s':'meses'}</strong>. 
       O d√©cimo bloco (R$ 90k‚ÜíR$ 100k) levou apenas <strong>${f10.meses} ${f10.meses===1?'m√™s':'meses'}</strong> ‚Äî 
       redu√ß√£o de <strong>${Math.round(((s10.meses-f10.meses)/s10.meses)*100)}%</strong>. 
       Quanto maior o saldo, mais √≠ngreme a curva e mais r√°pido cada bloco √© conquistado.`;

    const s100=groups100k[0], f100=groups100k[groups100k.length-1];
    document.getElementById('insight-100k').innerHTML =
      `O primeiro bloco de R$ 100.000 levou <strong>${s100.meses} ${s100.meses===1?'m√™s':'meses'}</strong>. 
       O √∫ltimo bloco (R$ 900k‚ÜíR$ 1M) levou apenas <strong>${f100.meses} ${f100.meses===1?'m√™s':'meses'}</strong> ‚Äî 
       queda de <strong>${Math.round(((s100.meses-f100.meses)/s100.meses)*100)}%</strong>. 
       Esse √© o poder dos juros compostos em escala.`;

    const pctValor = Math.round((saldoMeio/1000000)*100);
    document.getElementById('insight-500k').innerHTML =
      `Na metade do tempo (<strong>${mesesParaTexto(mesMeio)}</strong>), o patrim√¥nio era de apenas 
       <strong>${fmtFull(saldoMeio)}</strong> ‚Äî ou seja, <strong>${pctValor}% do milh√£o</strong>. 
       Os outros <strong>${100-pctValor}%</strong> vieram na segunda metade do mesmo per√≠odo. 
       Isso n√£o √© coincid√™ncia: √© a natureza exponencial dos juros compostos. O tempo inicial "planta a semente" ‚Äî 
       mas √© o tempo final que colhe a maior parte da colheita.`;

    document.getElementById('empty-results').classList.add('hidden');
    document.getElementById('section-10k').classList.remove('hidden');
    document.getElementById('section-100k').classList.remove('hidden');
    document.getElementById('section-500k').classList.remove('hidden');
  }

  function thin(serie, maxPts) {
    if (serie.length <= maxPts) return serie;
    const step = Math.ceil(serie.length/maxPts);
    const result=[];
    for (let i=0;i<serie.length;i++) {
      if (i===0||i===serie.length-1||i%step===0) result.push(serie[i]);
    }
    return result;
  }

  function renderMilestoneList(groups, listId, colorClass, badgeStyle) {
    const list = document.getElementById(listId);
    list.innerHTML='';
    groups.forEach((g,i) => {
      const div = document.createElement('div');
      div.className=`milestone-row ${colorClass}`;
      div.style.animationDelay=`${i*0.04}s`;
      const fasterPct = i>0 ? Math.round(((groups[0].meses-g.meses)/groups[0].meses)*100) : 0;
      div.innerHTML=`
        <div class="milestone-range">${fmt(g.from)} ‚Üí ${fmt(g.to)}</div>
        <div class="milestone-time">
          <span class="months-val">${g.meses}</span>
          <span>${g.meses===1?'m√™s':'meses'}</span>
          ${i>0&&fasterPct>0?`<span class="faster-badge" style="${badgeStyle}">‚àí${fasterPct}%</span>`:''}
        </div>`;
      list.appendChild(div);
    });
  }

  function renderTempoList(groupsTempo, saldoMeio, mesMeio, mesDoMilhao) {
    const list = document.getElementById('list-500k');
    list.innerHTML='';
    const pctValor = Math.round((saldoMeio/1000000)*100);

    // Row 1: primeira metade do tempo
    const d1 = document.createElement('div');
    d1.className='milestone-row g500k';
    d1.style.animationDelay='0s';
    d1.innerHTML=`
      <div class="milestone-range">
        <span style="font-size:11px;color:var(--muted);display:block;margin-bottom:2px">Primeira metade ‚Äî ${mesesParaTexto(mesMeio)}</span>
        R$ 0 ‚Üí ${fmtFull(saldoMeio)}
      </div>
      <div class="milestone-time">
        <span class="months-val">${pctValor}%</span>
        <span>do milh√£o</span>
      </div>`;
    list.appendChild(d1);

    // Row 2: segunda metade do tempo
    const d2 = document.createElement('div');
    d2.className='milestone-row g500k';
    d2.style.animationDelay='0.08s';
    const pct2 = 100-pctValor;
    d2.innerHTML=`
      <div class="milestone-range">
        <span style="font-size:11px;color:var(--muted);display:block;margin-bottom:2px">Segunda metade ‚Äî ${mesesParaTexto(mesDoMilhao-mesMeio)}</span>
        ${fmtFull(saldoMeio)} ‚Üí R$ 1.000.000
      </div>
      <div class="milestone-time">
        <span class="months-val" style="color:#a78bfa">${pct2}%</span>
        <span>do milh√£o</span>
        <span class="faster-badge" style="background:rgba(139,92,246,0.15);color:#a78bfa">+${pct2-pctValor}pp</span>
      </div>`;
    list.appendChild(d2);
  }

  // ‚îÄ‚îÄ Special chart for section 3: full curve + midpoint annotation + two colored zones ‚îÄ‚îÄ
  function buildChartTempo(canvasId, serieB, mesMeio, saldoMeio, mesDoMilhao) {
    const thinned = thin(serieB, 200);
    const curveData = thinned.map(p => ({ x:+(p.mes/12).toFixed(3), y:p.valor }));
    const meioAnos = +(mesMeio/12).toFixed(3);
    const fimAnos  = +(mesDoMilhao/12).toFixed(3);

    const existing = chart500kInstance;
    if (existing) existing.destroy();

    const ctx = document.getElementById(canvasId).getContext('2d');

    // Plugin to draw the two colored bands and midpoint annotation
    const splitPlugin = {
      id: 'splitZones',
      beforeDraw(chart) {
        const { ctx: c, scales, chartArea } = chart;
        if (!chartArea) return;
        const xScale = scales.x, yScale = scales.y;
        const midX = xScale.getPixelForValue(meioAnos);
        const left = xScale.left, right = xScale.right;
        const top = chartArea.top, bottom = chartArea.bottom;

        c.save();

        // Zone 1: left half ‚Äî subtle warm tint
        c.fillStyle='rgba(201,168,76,0.05)';
        c.fillRect(left, top, midX-left, bottom-top);

        // Zone 2: right half ‚Äî subtle violet tint
        c.fillStyle='rgba(139,92,246,0.07)';
        c.fillRect(midX, top, right-midX, bottom-top);

        // Midpoint vertical line
        c.beginPath();
        c.setLineDash([6,4]);
        c.strokeStyle='rgba(255,255,255,0.25)';
        c.lineWidth=1.5;
        c.moveTo(midX, top);
        c.lineTo(midX, bottom);
        c.stroke();
        c.setLineDash([]);

        // Midpoint dot on curve
        const midYPx = yScale.getPixelForValue(saldoMeio);
        c.beginPath();
        c.arc(midX, midYPx, 6, 0, Math.PI*2);
        c.fillStyle='#e8c97a';
        c.fill();
        c.strokeStyle='rgba(255,255,255,0.3)';
        c.lineWidth=2;
        c.stroke();

        // ‚îÄ‚îÄ Label for midpoint ‚îÄ‚îÄ
        const line1m = `${mesesParaTexto(mesMeio)}`;
        const line2m = fmtFull(saldoMeio);
        c.font='600 11px DM Mono, monospace';
        const bw1 = Math.max(c.measureText(line1m).width, c.measureText(line2m).width)+16;
        const bh1 = 34;
        let bx1 = midX - bw1 - 10;
        if (bx1 < left+4) bx1 = midX+10;
        const by1 = midYPx - bh1 - 12;

        c.beginPath();
        c.roundRect(bx1, by1, bw1, bh1, 4);
        c.fillStyle='rgba(10,12,18,0.92)';
        c.fill();
        c.strokeStyle='#c9a84c';
        c.lineWidth=1; c.globalAlpha=0.6; c.stroke(); c.globalAlpha=1;

        c.font='500 10px DM Sans, sans-serif';
        c.fillStyle='#9ca3af';
        c.textAlign='center'; c.textBaseline='top';
        c.fillText(line1m, bx1+bw1/2, by1+5);
        c.font='700 11px DM Mono, monospace';
        c.fillStyle='#c9a84c';
        c.fillText(line2m, bx1+bw1/2, by1+19);

        // ‚îÄ‚îÄ Zone labels ‚îÄ‚îÄ
        const zoneY = top + 14;
        c.font='600 10px DM Sans, sans-serif';
        c.textBaseline='top';

        // Left zone label
        c.fillStyle='rgba(201,168,76,0.7)';
        c.textAlign='left';
        c.fillText('1¬™ metade do tempo', left+8, zoneY);

        // Right zone label
        c.fillStyle='rgba(139,92,246,0.7)';
        c.textAlign='right';
        c.fillText('2¬™ metade do tempo', right-8, zoneY);

        // ‚îÄ‚îÄ End dot (R$1M) ‚îÄ‚îÄ
        const endX = xScale.getPixelForValue(fimAnos);
        const endY = yScale.getPixelForValue(1000000);
        c.beginPath();
        c.arc(endX, endY, 6, 0, Math.PI*2);
        c.fillStyle='#a78bfa';
        c.fill();
        c.strokeStyle='rgba(255,255,255,0.3)';
        c.lineWidth=2; c.stroke();

        // End label
        c.font='700 11px DM Mono, monospace';
        const endLbl = 'R$ 1.000.000';
        const bw2 = c.measureText(endLbl).width+16;
        const bh2 = 22;
        let bx2 = endX - bw2 - 10;
        if (bx2 < left) bx2 = endX - bw2/2;
        const by2 = endY - bh2 - 12;

        c.beginPath();
        c.roundRect(bx2, by2, bw2, bh2, 4);
        c.fillStyle='rgba(10,12,18,0.92)';
        c.fill();
        c.strokeStyle='#a78bfa';
        c.lineWidth=1; c.globalAlpha=0.6; c.stroke(); c.globalAlpha=1;

        c.fillStyle='#a78bfa';
        c.textAlign='center'; c.textBaseline='middle';
        c.fillText(endLbl, bx2+bw2/2, by2+bh2/2);

        c.restore();
      }
    };

    const instance = new Chart(ctx, {
      type: 'line',
      _milestones: [],
      plugins: [splitPlugin],
      data: {
        datasets: [{
          label: 'Patrim√¥nio',
          data: curveData,
          borderColor: '#a78bfa',
          backgroundColor: 'transparent',
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: '#a78bfa',
          borderWidth: 3,
          fill: false,
          tension: 0.4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        layout: { padding: { top: 36, right: 18, bottom: 8, left: 8 } },
        animation: { duration: 700, easing: 'easeInOutQuart' },
        interaction: { mode: 'nearest', intersect: false, axis: 'x' },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#0f1218',
            borderColor: '#2a3040',
            borderWidth: 1,
            titleColor: '#a78bfa',
            bodyColor: '#e2e8f0',
            padding: 10,
            callbacks: {
              title: items => mesesParaTexto(Math.round(items[0].parsed.x*12)),
              label: c => ` Patrim√¥nio: ${fmtFull(c.parsed.y)}`
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            title: { display:true, text:'Tempo (anos)', color:'#6b7280', font:{family:'DM Sans',size:11}, padding:{top:6} },
            grid:   { color:'rgba(255,255,255,0.04)' },
            border: { color:'#2a3040' },
            ticks:  { color:'#6b7280', font:{family:'DM Mono',size:10}, maxTicksLimit:10, callback: v => v%1===0?v:'' },
          },
          y: {
            title: { display:true, text:'Valor (R$)', color:'#6b7280', font:{family:'DM Sans',size:11}, padding:{bottom:6} },
            grid:   { color:'rgba(255,255,255,0.05)' },
            border: { color:'#2a3040' },
            beginAtZero: true,
            ticks:  { color:'#6b7280', font:{family:'DM Mono',size:10}, maxTicksLimit:8, callback: v => fmtAxis(v) },
          }
        }
      }
    });

    instance.config._milestones=[];
    return instance;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Smart label plugin: draws ALL milestones,
  // avoids overlaps by stacking vertically,
  // scales font based on chart width
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const verticalLinesPlugin = {
    id: 'verticalLines',
    afterDraw(chart) {
      const { ctx, scales, width } = chart;
      const milestones = chart.config._milestones;
      if (!milestones||!milestones.length) return;

      const xScale = scales.x, yScale = scales.y;
      const bottom = yScale.bottom, top = yScale.top;
      const chartW = xScale.right - xScale.left;

      // Responsive font size: scale between 8.5 and 11px
      const baseFontSize = Math.max(8.5, Math.min(11, chartW / (milestones.length * 14)));
      const lineH = baseFontSize + 3;
      const padX=8, padY=5;

      // First pass: compute pixel positions & natural label boxes
      const items = milestones.map(m => {
        const xPx = xScale.getPixelForValue(m.xAnos);
        const yPx = yScale.getPixelForValue(m.valor);
        const line1 = fmt(m.valor);
        const line2 = `‚Üì ${mesesParaTexto(m.mesesGrupo)}`;
        ctx.font = `700 ${baseFontSize}px DM Mono, monospace`;
        const w1 = ctx.measureText(line1).width;
        ctx.font = `500 ${baseFontSize}px DM Sans, sans-serif`;
        const w2 = ctx.measureText(line2).width;
        const bw = Math.max(w1,w2)+padX*2;
        const bh = lineH*2+padY*2;
        return { xPx, yPx, bw, bh, line1, line2, lineColor: m.lineColor };
      });

      // Second pass: position boxes, resolving vertical overlaps
      // Strategy: place above dot; if overlaps previous, shift down past it
      const placed = []; // {x1,y1,x2,y2} of placed boxes

      items.forEach((item, idx) => {
        const { xPx, yPx, bw, bh } = item;
        let bx = xPx - bw/2;
        // Clamp horizontally
        bx = Math.max(xScale.left+2, Math.min(xScale.right-bw-2, bx));

        // Start above dot
        let by = yPx - bh - 10;
        // If near top of chart, place below dot
        if (by < top+2) by = yPx + 10;

        // Resolve overlaps: push down if overlapping an already-placed box
        let attempts=0;
        let resolved=false;
        while (!resolved && attempts<20) {
          resolved=true;
          for (const p of placed) {
            const overlapX = bx < p.x2 && bx+bw > p.x1;
            const overlapY = by < p.y2 && by+bh > p.y1;
            if (overlapX && overlapY) {
              by = p.y2+3; // push below the conflicting box
              resolved=false;
              break;
            }
          }
          attempts++;
        }

        // Clamp vertically to chart bounds
        by = Math.max(top+2, Math.min(bottom-bh-2, by));

        placed.push({x1:bx, y1:by, x2:bx+bw, y2:by+bh});
        item._bx=bx; item._by=by;
      });

      // Draw everything
      items.forEach(item => {
        const { xPx, yPx, bw, bh, line1, line2, lineColor, _bx:bx, _by:by } = item;

        ctx.save();

        // Dashed vertical line from bottom to dot
        ctx.beginPath();
        ctx.setLineDash([4,3]);
        ctx.strokeStyle = lineColor;
        ctx.lineWidth = 1.5;
        ctx.globalAlpha = 0.55;
        ctx.moveTo(xPx, bottom);
        ctx.lineTo(xPx, yPx);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.globalAlpha = 1;

        // Connector line from box to dot (if box is not adjacent to dot)
        const boxCenterX = bx+bw/2;
        const boxBottom  = by+bh;
        const boxTop     = by;
        const dotAboveBox = yPx < by;
        const connY = dotAboveBox ? boxTop : boxBottom;
        if (Math.abs(yPx - connY) > 8) {
          ctx.beginPath();
          ctx.strokeStyle = lineColor;
          ctx.lineWidth = 1;
          ctx.globalAlpha = 0.35;
          ctx.moveTo(boxCenterX, connY);
          ctx.lineTo(xPx, yPx);
          ctx.stroke();
          ctx.globalAlpha = 1;
        }

        // Dot on curve
        ctx.beginPath();
        ctx.arc(xPx, yPx, 4.5, 0, Math.PI*2);
        ctx.fillStyle = lineColor;
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Label box
        ctx.beginPath();
        ctx.roundRect(bx, by, bw, bh, 4);
        ctx.fillStyle = 'rgba(10,12,18,0.92)';
        ctx.fill();
        ctx.strokeStyle = lineColor;
        ctx.lineWidth = 1;
        ctx.globalAlpha = 0.5;
        ctx.stroke();
        ctx.globalAlpha = 1;

        // Text line 1: value
        ctx.font=`700 ${baseFontSize}px DM Mono, monospace`;
        ctx.fillStyle = lineColor;
        ctx.textAlign='center';
        ctx.textBaseline='top';
        ctx.fillText(line1, bx+bw/2, by+padY);

        // Text line 2: group duration
        ctx.font=`500 ${baseFontSize}px DM Sans, sans-serif`;
        ctx.fillStyle='#9ca3af';
        ctx.fillText(line2, bx+bw/2, by+padY+lineH);

        ctx.restore();
      });
    }
  };

  Chart.register(verticalLinesPlugin);

  function buildChart(canvasId, serie, groups, lineColor) {
    const thinned = thin(serie, 200);
    const curveData = thinned.map(p => ({ x:+(p.mes/12).toFixed(3), y:p.valor }));

    // ALL groups become milestones (no filtering)
    const milestones = groups.map(g => ({
      xAnos:      +(g.mesCrossed/12).toFixed(3),
      valor:      g.to,
      mesesGrupo: g.meses,
      lineColor,
    }));

    const instances = {chart10k:chart10kInstance, chart100k:chart100kInstance, chart500k:chart500kInstance};
    if (instances[canvasId]) instances[canvasId].destroy();

    const ctx = document.getElementById(canvasId).getContext('2d');

    const instance = new Chart(ctx, {
      type: 'line',
      _milestones: milestones,
      data: {
        datasets: [{
          label: 'Patrim√¥nio',
          data: curveData,
          borderColor: lineColor,
          backgroundColor: 'transparent',
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: lineColor,
          borderWidth: 3,
          fill: false,
          tension: 0.4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        layout: { padding: { top: 18, right: 18, bottom: 8, left: 8 } },
        animation: { duration: 700, easing: 'easeInOutQuart' },
        interaction: { mode: 'nearest', intersect: false, axis: 'x' },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#0f1218',
            borderColor: '#2a3040',
            borderWidth: 1,
            titleColor: lineColor,
            bodyColor: '#e2e8f0',
            padding: 10,
            callbacks: {
              title: items => mesesParaTexto(Math.round(items[0].parsed.x*12)),
              label: c => ` Patrim√¥nio: ${fmtFull(c.parsed.y)}`
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            title: { display:true, text:'Tempo (anos)', color:'#6b7280', font:{family:'DM Sans',size:11}, padding:{top:6} },
            grid:   { color:'rgba(255,255,255,0.04)' },
            border: { color:'#2a3040' },
            ticks:  { color:'#6b7280', font:{family:'DM Mono',size:10}, maxTicksLimit:10, callback: v => v%1===0?v:'' },
          },
          y: {
            title: { display:true, text:'Valor (R$)', color:'#6b7280', font:{family:'DM Sans',size:11}, padding:{bottom:6} },
            grid:   { color:'rgba(255,255,255,0.05)' },
            border: { color:'#2a3040' },
            beginAtZero: true,
            ticks:  { color:'#6b7280', font:{family:'DM Mono',size:10}, maxTicksLimit:8, callback: v => fmtAxis(v) },
          }
        }
      }
    });

    instance.config._milestones = milestones;
    return instance;
  }

  // Add g500k color to milestone list
  const style = document.createElement('style');
  style.textContent = `
    .milestone-row.g500k::before { background: #a78bfa; }
    .g500k .milestone-time .months-val { color: #a78bfa; }
  `;
  document.head.appendChild(style);

  calcular();
</script>
</body>
</html>
